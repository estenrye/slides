variable "vm_name" {
  type = string
  default = "{{ inventory_hostname | replace('_','-') }}-{{ inventory_date }}"
}

variable "template_description" {
  type = string
  default = "{{ vm_notes | default("") }}"
}

variable "ssh_username" {
  type = string
  default = "{{ user.username }}"
}

variable "ssh_certificate_file" {
  type = string
  default = "~/.ssh/id_rsa"
}

variable "iso_url" {
  type = string
  default = "local:iso/custom_{{ iso_name }}"
}

variable "cidata_iso_url" {
  type = string
  default = "local:iso/{{ inventory_hostname }}_{{ inventory_date }}_cidata.iso"
}

variable "cidata_iso_checksum" {
  type = string
  default = "{{ cidata_iso_checksum | default('') }}"
}

variable "iso_checksum" {
  type = string
  default = "{{ custom_iso_checksum | default('') }}"
}

variable "proxmox_url" {
  type = string
  default = "{{ proxmox_cluster_api }}"
}

variable "proxmox_insecure_skip_tls_verify" {
  type = bool
  default = {{ proxmox_insecure_skip_tls_verify | bool | lower }}
}

variable "proxmox_node" {
  type = string
  default = "{{ proxmox_cluster_node }}"
}

variable "proxmox_network_bridge" {
  type = string
  default = "{{ proxmox_network_bridge }}"
}

variable "proxmox_username" {
  type = string
  default = "{{ proxmox_cluster_username }}"
}

variable "proxmox_password" {
  type = string
  default = "{{ proxmox_cluster_password }}"
}

source "proxmox-iso" "proxmox" {
  proxmox_url = var.proxmox_url
  insecure_skip_tls_verify = var.proxmox_insecure_skip_tls_verify
  username = var.proxmox_username
  password = var.proxmox_password
  vm_name = var.vm_name
  qemu_agent = true
  template_name = var.vm_name
  template_description = var.template_description
  memory = 8192
  cores = 4
  os = "l26"
  node = var.proxmox_node
  ssh_username = var.ssh_username
  ssh_private_key_file = var.ssh_certificate_file
  ssh_timeout = "60m"
  iso_file = var.iso_url
  iso_checksum = var.iso_checksum
  iso_storage_pool = "local"
  unmount_iso = true  # TODO: Review this setting.
  cloud_init = false

  additional_iso_files {
    device = "ide3"
    iso_file = var.cidata_iso_url
    iso_checksum = var.cidata_iso_checksum
    unmount = true  # TODO: Review this setting.
  }

  boot = "order=virtio0;ide2;net0"
  boot_wait = "5s"

  network_adapters {
    model = "virtio"
    bridge = var.proxmox_network_bridge
  }

  disks {
    type = "virtio"
    disk_size = "{{ disks.boot.size }}"
    storage_pool = "local-lvm"
    storage_pool_type = "lvm-thin"
    format = "qcow2"
  }
}

build {
  name = "proxmox"
  sources = [ "source.proxmox-iso.proxmox" ]

  provisioner "ansible" {
    use_proxy = false
    playbook_file = "/ansible/playbooks/_hardening/apply-hardening.yml"
    extra_arguments = [
      "--extra-vars", "@/ansible/playbooks/_hardening/vars/proxmox.yml"
    ]
  }
}
